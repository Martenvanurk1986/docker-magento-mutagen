#!/bin/bash
set -e

## change into directory one level above where this script is located allowing it to be run from anywhere
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )/.."

for i in "$@"
    do
        case ${i} in
            -v=*|--version=*) VERSION="${i#*=}"; shift;;
            -i|--images) IMAGES=1; shift;;
            -a|--all) ALL=1; shift;;
            *)
                >&2 ERROR="$ERROR $i"
                ;;
        esac
    done

if [[ ! -z "$ERROR" ]]; then
    echo
    printf "\e[01;31mError: Unrecognized argument: %s\n\e[m" ${ERROR}
    exit
fi

if [[ ! -z "$ALL" ]] || [[ -z "$IMAGES" ]]; then
    printf "Fetching latest version..."
    VERSION=${VERSION:-feature/magento-1}
    rm -rf tmp-mage2click
    mkdir tmp-mage2click
    cd tmp-mage2click
    git init -qqq
    git remote add origin https://github.com/mage2click/docker-magento-mutagen
    git fetch origin -qqq
    git checkout origin/${VERSION} -- compose/magento-1
    rm -rf ../bin
    cp -Rf compose/magento-1/bin ../
    if [[ ! -f "../env/_config" ]]; then
        cp -Rf compose/magento-1/env/_config ../env/
    fi
    cd ../
    rm -rf tmp-mage2click
    printf " DONE!"
fi

if [[ ! -z "$ALL" ]] || [[ ! -z "$IMAGES" ]]; then
    bin/mutagen stop || true
    docker-compose down --rmi all
    docker-compose up -d
    bin/fixowns # Fix for Mutagen Error: create failed: unable to connect to beta: unable to connect to endpoint:
                # unable to install agent: unable to invoke agent installation: exit status 1
    bin/mutagen start
fi
