#!/bin/bash
set -eu

## change into directory one level above where this script is located allowing it to be run from anywhere
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )/.."

stop() {
    bin/stop 2> /dev/null || true
}

backup() {
    stop && \
    docker run --rm --volumes-from $(docker-compose ps -q db|awk '{print $1}') -v $(pwd):/backup busybox \
           tar cvf /backup/dbdata.tar var/lib/mysql
}

restore() {
    stop && \
    docker run --rm --volumes-from $(docker-compose ps -q db|awk '{print $1}') -v $(pwd):/backup busybox \
           ash -c "rm -rf var/lib/mysql/* && cd var && tar xvf /backup/dbdata.tar --strip 1"
}

usage() {
    echo "Usage:
  bin/project <backup|restore|archive|up>

Commands:
  backup    Backup db container volume to dbdata.tar archive
  restore   Restore db container volume from dbdata.tar archive
  archive   Archive project (backups db container volume, removes project containers and volumes)
  up        Restore project (Creates containers, volumes, restores db container volume)
"
}

case "$@" in
    backup) backup && bin/start;;
    restore) restore && bin/start;;
    archive) backup && bin/remove -a;;
    up) restore && bin/start;;
    *) usage && exit;;
esac
